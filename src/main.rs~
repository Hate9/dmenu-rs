#![allow(unused)]
use x11::xft::*;
use x11::xlib::*;
use x11::xrender::*;
use std::ptr;
use std::ffi::{CString};
use std::os::raw::{c_uchar};
use libc::{setlocale, LC_CTYPE};

use std::mem::{self, MaybeUninit};

mod drw;
use drw::Drw;
mod config;
use config::*;

/*
fn setup() {
    int x, y, i, j;
    unsigned int du;
    XSetWindowAttributes swa;
    XIM xim;
    Window w, dw, *dws;
    XWindowAttributes wa;
    XClassHint ch = {"dmenu", "dmenu"};
    //#ifdef XINERAMA // TODO
    //XineramaScreenInfo *info;
    //Window pw;
    //int a, di, n, area = 0;
    //#endif
    /* init appearance */
    
    for (j = 0; j < SchemeLast; j++)
	scheme[j] = drw.scm_create(COLORS[j], 2);
}*/

fn main() {
    let default_font = CString::new("monospace:size=10").unwrap().into_raw();
    let fonts = vec![default_font]; // TODO: move into config
    let embed = 0; // TODO
    unsafe {
	let mut wa: XWindowAttributes = MaybeUninit::uninit().assume_init();//<_>::uninit_alloc();
	// TODO: command line arguements
	if (setlocale(LC_CTYPE, ptr::null())==ptr::null_mut() || XSupportsLocale()==0) {
	    eprintln!("warning: no locale support\n");
	}
	let dpy = XOpenDisplay(ptr::null_mut());
	if (dpy==ptr::null_mut()) {
	    panic!("cannot open display");
	}
	let screen = XDefaultScreen(dpy);
	let root = XRootWindow(dpy, screen);

	let parentwin =
	    if (embed == 0) {
		root
	    } else {
		embed
	    };
	XGetWindowAttributes(dpy, parentwin, &mut wa); // will non-gracefully panic on fail with a decent error message
	let mut drw = Drw::new(dpy, screen, root, wa);
	if(!drw.fontset_create(fonts)) {
	    panic!("no fonts could be loaded.");
	}
	println!("{:?}", drw);

    }
}
